Metadata-Version: 2.4
Name: NoWebsocket
Version: 2.0.0
Summary: ä¸€ä¸ªPython WebSocketæœåŠ¡ç«¯æ¡†æ¶ï¼Œæ”¯æŒé›¶é…ç½®å¤šæ–‡ä»¶è·¯ç”±ç®¡ç†ï¼Œå®ç°é«˜æ•ˆã€æ¨¡å—åŒ–çš„å®æ—¶é€šä¿¡å¼€å‘ã€‚
Home-page: https://github.com/dzy-china/NoWebsocket
Author: dzy
Author-email: 1129881228@qq.com
Classifier: Programming Language :: Python :: 3
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Requires-Python: >=3.7
Description-Content-Type: text/markdown
License-File: LICENSE
Dynamic: author
Dynamic: author-email
Dynamic: classifier
Dynamic: description
Dynamic: description-content-type
Dynamic: home-page
Dynamic: license-file
Dynamic: requires-python
Dynamic: summary


# NoWebsocket åº“ ä½¿ç”¨æ–‡æ¡£
**ä¸€ä¸ªPython WebSocketæœåŠ¡ç«¯æ¡†æ¶ï¼Œæ”¯æŒé›¶é…ç½®å¤šæ–‡ä»¶è·¯ç”±ç®¡ç†ï¼Œå®ç°é«˜æ•ˆã€æ¨¡å—åŒ–çš„å®æ—¶é€šä¿¡å¼€å‘ã€‚**

## å®‰è£…æŒ‡å—

### ç¯å¢ƒè¦æ±‚
- Python 3.7+
- ä¾èµ–åº“ï¼šæ— é¢å¤–ä¾èµ–

### å®‰è£…æ­¥éª¤
1. å°†åº“ä»£ç å…‹éš†åˆ°é¡¹ç›®ç›®å½•ï¼š
   ```bash
   git clone git@github.com:dzy-china/NoWebsocket.git
   ```
2. pipå®‰è£…ï¼š
   ```python
   pip install NoWebsocket
   ```

---

## å¿«é€Ÿå¼€å§‹

### åˆ›å»ºä¸€ä¸ªç®€å•çš„WebSocketæœåŠ¡å™¨
```python
from NoWebsocket import WebSocketServer, WebSocketRouter, WebSocketApplication

# å®šä¹‰åº”ç”¨ç±»
class EchoApp(WebSocketApplication):
    def on_message(self, message):
        self.connection.send_text(f"Echo: {message}")

# é…ç½®è·¯ç”±
router = WebSocketRouter()
router.add_route("/echo", EchoApp)

# å¯åŠ¨æœåŠ¡å™¨
server = WebSocketServer(("0.0.0.0", 8765), router)
print("Server running on ws://localhost:8765/echo")
server.serve_forever()
```

### æµ‹è¯•è¿æ¥
ä½¿ç”¨WebSocketå®¢æˆ·ç«¯å·¥å…·ï¼ˆå¦‚`websocat`ï¼‰è¿æ¥ï¼š
```bash
websocat ws://localhost:8765/echo
```

## ä¼˜é›…å¼€å§‹

> å…¥å£æ–‡ä»¶ï¼šmain.py

```python
from NoWebsocket import WebSocketServer, WebSocketRouter, Blueprint


def create_app():
    router = WebSocketRouter()

    # è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰è“å›¾
    Blueprint.auto_register(
        router,
        package_path='blueprints',
        bp_suffix='_bp'
    )

    return WebSocketServer(("0.0.0.0", 9000), router)


if __name__ == "__main__":
    server = create_app()
    print("WebSocket server running on ws://localhost:9000")
    try:
        server.serve_forever()  # å¯åŠ¨æœåŠ¡
    except KeyboardInterrupt:
        server.shutdown()  # ä¼˜é›…å…³é—­
        print("\nğŸ›‘ Server stopped")
```

> è·¯ç”±æ§åˆ¶å™¨å¤„ç†æ–‡ä»¶ï¼šblueprints/chat/Uer.py
>
> blueprintsåŒ…ä¸‹å¿…é¡»å­˜åœ¨`__init__.py`,è¯¥æ–‡ä»¶å¯ä»¥ä¸ºç©ºï¼Œ
> ä¸€ä¸ªç›®å½•å¿…é¡»åŒ…å«`__init__.py`æ–‡ä»¶æ‰èƒ½è¢«è¯†åˆ«ä¸º**åŒ…**ï¼ˆPackageï¼‰ï¼Œè¿™æ˜¯Pythonæ¨¡å—ç³»ç»Ÿçš„çº¦å®š

```python
from NoWebsocket import WebSocketApplication, Blueprint

chat_bp = Blueprint(prefix='/chat')

@chat_bp.route("/youmi")
class User(WebSocketApplication):
    def on_open(self):
        """è¿æ¥å»ºç«‹æ—¶è§¦å‘"""
        pass

    def on_message(self, message):
        print(message)
        self.connection.send_text(f"ä½ å¥½ï¼Œæˆ‘æ˜¯æ‚ ç±³ç³»ç»ŸæœåŠ¡ï¼Œæ”¶åˆ°äº†ä½ çš„ä¿¡æ¯ï¼š\'{message}\'")

    def on_binary(self, data):
        """æ”¶åˆ°äºŒè¿›åˆ¶æ¶ˆæ¯æ—¶è§¦å‘"""
        print(data)

    def on_close(self):
        """è¿æ¥å…³é—­æ—¶è§¦å‘"""
        print("on_close")
```

> æµ‹è¯•è¿æ¥ index.html

```html
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <title>WebSocket ç¤ºä¾‹</title>
</head>
<body>
<div>
    <p>è¿æ¥çŠ¶æ€: <span id="status">æœªè¿æ¥</span></p>
    <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯">
    <button onclick="sendMessage()">å‘é€</button>
</div>
<div id="messages"></div>

<script>
    // åˆ›å»º WebSocket è¿æ¥
    const socket = new WebSocket('ws://localhost:9000/chat/youmi'); // ä½¿ç”¨å…¬å¼€æµ‹è¯•æœåŠ¡å™¨

    // è¿æ¥æ‰“å¼€æ—¶è§¦å‘
    socket.addEventListener('open', (event) => {
        updateStatus('å·²è¿æ¥');
        logMessage('ç³»ç»Ÿ: è¿æ¥å·²å»ºç«‹');

        // å‘é€åˆå§‹æµ‹è¯•æ¶ˆæ¯
        socket.send('ä½ å¥½ï¼ŒæœåŠ¡å™¨!');
    });

    // æ¥æ”¶æ¶ˆæ¯æ—¶è§¦å‘
    socket.addEventListener('message', (event) => {
        logMessage(`æœåŠ¡å™¨: ${event.data}`);
    });

    // é”™è¯¯å¤„ç†
    socket.addEventListener('error', (event) => {
        updateStatus('è¿æ¥é”™è¯¯');
        console.error('WebSocket é”™è¯¯:', event);
    });

    // è¿æ¥å…³é—­æ—¶è§¦å‘
    socket.addEventListener('close', (event) => {
        updateStatus('è¿æ¥å·²å…³é—­');
        logMessage(`ç³»ç»Ÿ: è¿æ¥å…³é—­ (ä»£ç  ${event.code})`);
    });

    // å‘é€æ¶ˆæ¯
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value;

        if (message) {
            socket.send(message);
            logMessage(`ä½ : ${message}`);
            input.value = '';
        }
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(status) {
        document.getElementById('status').textContent = status;
    }

    // è®°å½•æ¶ˆæ¯åˆ°é¡µé¢
    function logMessage(message) {
        const messagesDiv = document.getElementById('messages');
        const p = document.createElement('p');
        p.textContent = message;
        messagesDiv.appendChild(p);
    }
</script>
</body>
</html>
```

### é…ç½®é€‰é¡¹
åœ¨æœåŠ¡å™¨åˆå§‹åŒ–æ—¶è®¾ç½®ï¼š
```python
server = WebSocketServer(
    ("0.0.0.0", 8765),
    router,
    max_header_size=8192,       # æœ€å¤§è¯·æ±‚å¤´å¤§å°
    max_message_size=4*1024*1024, # æœ€å¤§æ¶ˆæ¯å¤§å°ï¼ˆ4MBï¼‰
    read_timeout=60              # ç­‰å¾…è¯»å–ä¿¡æ¯è¶…æ—¶ï¼ˆç§’ï¼‰
)
```

---

## è·¯ç”±ç®¡ç†

### è£…é¥°å™¨è·¯ç”±

> blueprints/chat/Uer.py

```python
from NoWebsocket import WebSocketApplication, Blueprint

chat_bp = Blueprint(prefix='/chat')  # è“å›¾å®ä¾‹


@chat_bp.route("/youmi")
class User(WebSocketApplication):
    def on_open(self):
        """è¿æ¥å»ºç«‹æ—¶è§¦å‘"""
        pass

    def on_message(self, message):
        print(message)
        self.connection.send_text(f"ä½ å¥½ï¼Œæˆ‘æ˜¯æ‚ ç±³æœåŠ¡ï¼Œæ”¶åˆ°äº†ä½ çš„ä¿¡æ¯ï¼š\'{message}\'")

    def on_binary(self, data):
        """æ”¶åˆ°äºŒè¿›åˆ¶æ¶ˆæ¯æ—¶è§¦å‘"""
        print(data)

    def on_close(self):
        """è¿æ¥å…³é—­æ—¶è§¦å‘"""
        print("on_close")
```

### çº¦å®šé…ç½®
> main.py

```python
from NoWebsocket import Blueprint

Blueprint.auto_register(
    router,
    package_path="blueprints", # æŒ‡å®šè·¯ç”±æ–‡ä»¶å­˜æ”¾çš„åŒ…ï¼ŒåŒ…å†…å¿…é¡»å­˜åœ¨`__init__.py`æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯ä»¥ä¸ºç©º
    # æŒ‡å®šè“å›¾å®ä¾‹å˜é‡åç¼€ï¼Œä¸å†™é»˜è®¤ä¸º'_bp'
    # å¦‚ï¼š'chat_bp = Blueprint(prefix='/chat')'
    bp_suffix="_bp"
)
```

> `bp_suffix`å‚æ•°çš„å­˜åœ¨æ˜¯**ä¸ºäº†å¹³è¡¡çµæ´»æ€§ä¸è§„èŒƒæ€§**ï¼Œå®ƒé€šè¿‡å‘½åçº¦å®šå¸®åŠ©å¼€å‘è€…æ›´ç²¾ç¡®åœ°æ§åˆ¶å“ªäº›è“å›¾å®ä¾‹åº”è¢«è‡ªåŠ¨æ³¨å†Œ



**ç›®å½•ç»“æ„ç¤ºä¾‹**ï¼š

```
project/
â”œâ”€â”€ blueprints/
	__init__.py  # å¿…é¡»å­˜åœ¨ï¼Œå¯ä»¥ä¸ºç©º
â”‚   â””â”€â”€ chat/
â”‚       â””â”€â”€ User.py   # åŒ…å« chat_bp = Blueprint()
â””â”€â”€ main.py
```

---

## é«˜çº§é…ç½®

### è‡ªå®šä¹‰è·¯ç”±å‰ç¼€
```python
api_bp = Blueprint(prefix="/api/v2")

@api_bp.route("/status")
class StatusHandler(WebSocketApplication):
    def on_open(self):
        self.connection.send_text("API v2 Ready")
```

### å‚æ•°åŒ–è·¯ç”±
**å®šä¹‰åŠ¨æ€è·¯å¾„**ï¼š

```python
router.add_route("/user/{user_id:int}", UserHandler)
```

**åœ¨åº”ç”¨ä¸­è·å–å‚æ•°**ï¼š

```python
class UserHandler(WebSocketApplication):
    def on_open(self):
        user_id = self.path_params["user_id"]
        self.connection.send_text(f"User ID: {user_id}")
```

---

## ç¤ºä¾‹åº”ç”¨

### èŠå¤©åº”ç”¨

```python
# blueprints/chat/handlers.py
from NoWebsocket import WebSocketApplication, Blueprint

chat_bp = Blueprint(prefix="/chat")


@chat_bp.route("/public")
class PublicChat(WebSocketApplication):
    def on_message(self, message):
        self.connection.send_text(f"[Public] {message}")


@chat_bp.route("/private/{room}")
class PrivateChat(WebSocketApplication):
    def on_message(self, message):
        room = self.path_params["room"]
        self.connection.send_text(f"[{room}] {message}")
```

### æ–‡ä»¶ä¼ è¾“

```python
# blueprints/file/handlers.py
from NoWebsocket import WebSocketApplication, Blueprint

file_bp = Blueprint(prefix="/file")


@file_bp.route("/upload")
class FileUpload(WebSocketApplication):
    def on_binary(self, data):
        with open("received_file.bin", "ab") as f:
            f.write(data)
```

---

## å¸¸è§é—®é¢˜

### 1. å¦‚ä½•å¤„ç†è¿æ¥ä¸­æ–­ï¼Ÿ
- **ç°è±¡**ï¼šå®¢æˆ·ç«¯æ„å¤–æ–­å¼€ã€‚
- **è§£å†³**ï¼šåœ¨`on_close`ä¸­æ¸…ç†èµ„æºï¼š
  ```python
  class MyApp(WebSocketApplication):
      def on_close(self):
          print("Connection closed")
  ```

### 2. å¦‚ä½•è°ƒè¯•åè®®é”™è¯¯ï¼Ÿ
- **æ­¥éª¤**ï¼š
  1. å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
     ```python
     import logging
     logging.basicConfig(level=logging.DEBUG)
     ```
  2. æ£€æŸ¥æ¡æ‰‹å¤´å’Œå¸§æ ¼å¼æ˜¯å¦ç¬¦åˆRFC6455ã€‚

### 3. å¦‚ä½•æ‰©å±•åº”ç”¨åŸºç±»ï¼Ÿ
- **ç¤ºä¾‹**ï¼šæ·»åŠ èº«ä»½éªŒè¯ï¼š
  
  ```python
  class AuthApp(WebSocketApplication):
      def on_open(self):
          token = self.connection.request.headers.get("token")
          if not validate_token(token):
              self.connection.close(1008, "Invalid token")
  ```

---

