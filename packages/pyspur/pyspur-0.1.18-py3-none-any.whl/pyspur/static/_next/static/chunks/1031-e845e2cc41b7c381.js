"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1031],{21031:(e,s,t)=>{t.d(s,{A:()=>_});var a=t(37876),l=t(28080),r=t(21379),n=t(14232),i=t(7700),o=t(3576),c=t(31777),d=t(3895),u=t(34233);let m=e=>{let{workflowID:s,sessionId:t}=e,a=(0,c.wA)(),l=(0,c.d4)(e=>e.flow.nodes),[r,m]=(0,n.useState)(!1),[x,f]=(0,n.useState)(null),p=(0,n.useRef)([]),[h,g]=(0,n.useState)(()=>t||"chat_session_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9)));(0,n.useEffect)(()=>{t&&g(t)},[t]),(0,n.useEffect)(()=>()=>{p.current.forEach(e=>clearInterval(e)),p.current=[]},[]);let w=(0,n.useCallback)(e=>{0!==e.length&&e.forEach(e=>{let s=e.node_id,t=l.find(e=>e.id===s||e.data.title===s);if(!t){let e=u.A.getState(),a=Object.keys(e.flow.nodeConfigs).find(t=>e.flow.nodeConfigs[t].title===s);a&&(t=l.find(e=>e.id===a))}if(!t)return;let r=e.outputs||{},n=e.status;e.subworkflow_output&&Object.entries(e.subworkflow_output).forEach(e=>{let[s,t]=e,r=l.find(e=>e.id===s||e.data.title===s);r&&a((0,d.Kp)({id:r.id,data:{run:t,taskStatus:"COMPLETED"}}))}),t&&a((0,d.Kp)({id:t.id,data:{run:(0,o._)({},r),error:e.error||null,taskStatus:n}}))})},[l,a]);return{isLoading:r,error:x,executeWorkflow:(0,n.useCallback)(async e=>{if(!s)return f("No workflow connected"),null;try{m(!0),f(null),p.current.forEach(e=>clearInterval(e)),a((0,d.bT)());let t=(await (0,i.AD)(s,{input_node:{user_message:e,session_id:h,message_history:[]}},null,"interactive")).id;return new Promise(e=>{let s=setInterval(async()=>{try{let a=await (0,i.Wb)(t),l=a.tasks;if(w(l),"COMPLETED"===a.status||"FAILED"===a.status){clearInterval(s);let r=p.current.indexOf(s);r>-1&&p.current.splice(r,1);let n=a.workflow_version.definition.nodes.find(e=>"OutputNode"===e.node_type);if(!n){m(!1),f("No output node found in workflow"),e({role:"assistant",message:"Error: No output node found in workflow"});return}let i=l.find(e=>"COMPLETED"===e.status&&e.node_id===n.id&&e.outputs);if(i&&i.outputs){let s=i.outputs.assistant_message||JSON.stringify(i.outputs);m(!1),e({role:"assistant",message:"string"==typeof s?s:JSON.stringify(s),runId:t})}else if("FAILED"===a.status){let s=l.find(e=>"FAILED"===e.status),a=(null==s?void 0:s.error)||"Workflow execution failed";m(!1),f(a),e({role:"assistant",message:"Error: ".concat(a),runId:t})}else m(!1),f("Workflow completed but no response was generated"),e({role:"assistant",message:"Sorry, I couldn't generate a response.",runId:t})}}catch(a){console.error("Error checking workflow status:",a),clearInterval(s);let t=p.current.indexOf(s);t>-1&&p.current.splice(t,1),m(!1),f("Error checking workflow status"),e({role:"assistant",message:"Sorry, an error occurred while processing your message."})}},1e3);p.current.push(s)})}catch(e){return console.error("Error executing chat workflow:",e),m(!1),f((null==e?void 0:e.message)||"Failed to execute workflow"),{role:"assistant",message:"Sorry, an error occurred while processing your message."}}},[s,h,a,w]),cleanup:(0,n.useCallback)(()=>{p.current.forEach(e=>clearInterval(e)),p.current=[]},[]),sessionId:h}};var x=t(62701),f=t(65699),p=t(84734),h=t(5060),g=t(42627),w=t(88705),v=t(22196),j=t(7305),y=t(58170),N=t(48396),b=t(98594),I=t(99615);let k=n.forwardRef((e,s)=>{var{avatar:t,message:l,showFeedback:r,attempts:i=1,currentAttempt:c=1,status:d,runId:u,onMessageCopy:m,onAttemptChange:k,onFeedback:C,onAttemptFeedback:S,className:E,messageClassName:_}=e,D=(0,f._)(e,["avatar","message","showFeedback","attempts","currentAttempt","status","runId","onMessageCopy","onAttemptChange","onFeedback","onAttemptFeedback","className","messageClassName"]);let[P,T]=n.useState(),[A,M]=n.useState(),O=n.useRef(null),{copied:R,copy:z}=(0,N.i)(),L=(0,a.jsxs)("p",{children:["Something went wrong, if the issue persists please contact us through our help center at\xa0",(0,a.jsx)(p.h,{href:"mailto:support@pyspur.dev",size:"sm",children:"support@pyspur.dev"})]}),W=(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(b.In,{className:"text-default-500 animate-spin",icon:"gravity-ui:spinner"}),(0,a.jsx)("p",{children:"Generating response..."})]}),H="failed"===d,F="loading"===d,G=n.useCallback(()=>{var e;let s="";"string"==typeof l?s=l:Array.isArray(l)&&l.forEach(e=>{var t,a;let l="string"==typeof e?e:null==e?void 0:null===(a=e.props)||void 0===a?void 0:null===(t=a.children)||void 0===t?void 0:t.toString();l&&(s+=l+"\n")});let t=s||(null===(e=O.current)||void 0===e?void 0:e.textContent)||"";z(t),null==m||m(t)},[z,l,m]),J=n.useCallback(e=>{T(e?"like":"dislike"),null==C||C(e?"like":"dislike")},[C]),Z=n.useCallback(e=>{M(e),null==S||S(e)},[S]);return(0,a.jsxs)("div",(0,x._)((0,o._)({},D),{ref:s,className:(0,h.cn)("flex gap-3",E),children:[(0,a.jsx)("div",{className:"relative flex-none",children:(0,a.jsx)(g.w,{isOneChar:!0,color:"danger",content:(0,a.jsx)(b.In,{className:"text-background",icon:"gravity-ui:circle-exclamation-fill"}),isInvisible:!H,placement:"bottom-right",shape:"circle",children:(0,a.jsx)(w.Q,{src:t})})}),(0,a.jsxs)("div",{className:"flex w-full flex-col gap-4",children:[(0,a.jsxs)("div",{className:(0,h.cn)("relative w-full rounded-medium bg-content2 px-4 py-3 text-default-600","failed"===d?"bg-danger-100/50 border border-danger-100 text-foreground":"","loading"===d?"bg-default-100/50 border border-default-100 text-foreground":"",_),children:[(0,a.jsx)("div",{ref:O,className:"pr-20 text-small",children:H?L:F?W:"string"==typeof l?(0,a.jsx)(I.o,{children:l}):l}),r&&!H&&!F&&(0,a.jsxs)("div",{className:"absolute right-2 top-2 flex rounded-full bg-content2 shadow-small",children:[(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:G,children:R?(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:check"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:copy"})}),(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:()=>J(!0),children:"like"===P?(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-up-fill"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-up"})}),(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:()=>J(!1),children:"dislike"===P?(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-down-fill"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-down"})})]}),i>1&&!H&&!F&&(0,a.jsxs)("div",{className:"flex w-full items-center justify-end",children:[(0,a.jsx)("button",{onClick:()=>null==k?void 0:k(c>1?c-1:1),children:(0,a.jsx)(b.In,{className:"cursor-pointer text-default-400 hover:text-default-500",icon:"gravity-ui:circle-arrow-left"})}),(0,a.jsx)("button",{onClick:()=>null==k?void 0:k(c<i?c+1:i),children:(0,a.jsx)(b.In,{className:"cursor-pointer text-default-400 hover:text-default-500",icon:"gravity-ui:circle-arrow-right"})}),(0,a.jsxs)("p",{className:"px-1 text-tiny font-medium text-default-500",children:[c,"/",i]})]}),u&&(0,a.jsx)("div",{className:"flex w-full items-center justify-end mt-2",children:(0,a.jsx)(j.R,{size:"sm",variant:"flat",className:"cursor-pointer",onClick:()=>window.open("/trace/".concat(u),"_blank"),children:u})})]}),r&&i>1&&!H&&!F&&(0,a.jsxs)("div",{className:"flex items-center justify-between rounded-medium border-small border-default-100 px-4 py-3 shadow-small",children:[(0,a.jsx)("p",{className:"text-small text-default-600",children:"Was this response better or worse?"}),(0,a.jsxs)("div",{className:"flex gap-1",children:[(0,a.jsx)(y.I,{content:"Better",children:(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:()=>Z("like"),children:"like"===A?(0,a.jsx)(b.In,{className:"text-lg text-primary",icon:"gravity-ui:thumbs-up-fill"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-up"})})}),(0,a.jsx)(y.I,{content:"Worse",children:(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:()=>Z("dislike"),children:"dislike"===A?(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-down-fill"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-down"})})}),(0,a.jsx)(y.I,{content:"Same",children:(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:()=>Z("same"),children:"same"===A?(0,a.jsx)(b.In,{className:"text-lg text-danger",icon:"gravity-ui:face-sad"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:face-sad"})})})]})]})]})]}))});k.displayName="MessageCard";var C=t(95035);let S=n.forwardRef((e,s)=>{var{classNames:t={}}=e,l=(0,f._)(e,["classNames"]);return(0,a.jsx)(C.P,(0,o._)({ref:s,"aria-label":"Prompt",className:"min-h-[40px]",classNames:(0,x._)((0,o._)({},t),{label:(0,h.cn)("hidden",null==t?void 0:t.label),input:(0,h.cn)("py-0",null==t?void 0:t.input)}),minRows:1,placeholder:"Enter a prompt here",radius:"lg",variant:"bordered"},l))});function E(e){let{onSendMessage:s,isLoading:t=!1,placeholder:l="Enter a prompt here",disabled:r=!1,showRegenerateButton:i=!0}=e,[o,c]=n.useState(!1),[d,u]=n.useState(""),m=n.useRef(null),x=()=>{d.trim()&&s&&(s(d),u(""))};return(0,a.jsxs)("div",{className:"flex w-full flex-col gap-1",children:[i&&(0,a.jsx)("div",{children:(0,a.jsx)(v.T,{isDisabled:o||t||r,size:"sm",className:"h-7 min-w-0 px-2",startContent:(0,a.jsx)(b.In,{className:(0,h.cn)("text-medium",o?"origin-center animate-spin":""),icon:"solar:restart-linear",width:14}),variant:"flat",onPress:()=>{c(!0),setTimeout(()=>{c(!1)},1e3)},children:(0,a.jsx)("span",{className:"text-xs",children:"Regenerate"})})}),(0,a.jsxs)("form",{className:"flex w-full flex-col items-start rounded-medium bg-default-100 transition-colors hover:bg-default-200/70",onSubmit:e=>{e.preventDefault(),x()},children:[(0,a.jsx)(S,{ref:m,classNames:{inputWrapper:"!bg-transparent shadow-none",innerWrapper:"relative",input:"pt-1 pl-2 pb-4 !pr-10 text-medium max-h-20"},endContent:(0,a.jsx)("div",{className:"flex items-end gap-2",children:(0,a.jsx)(y.I,{showArrow:!0,content:"Send message",children:(0,a.jsx)(v.T,{isIconOnly:!0,color:d?"primary":"default",isDisabled:!d||t||r,radius:"lg",size:"sm",variant:"solid",onPress:x,type:"submit",children:(0,a.jsx)(b.In,{className:(0,h.cn)("[&>path]:stroke-[2px]",d?"text-primary-foreground":"text-default-600"),icon:"solar:arrow-up-linear",width:20})})})}),minRows:1,maxRows:3,radius:"lg",value:d,variant:"flat",onValueChange:u,isDisabled:t||r,placeholder:l,onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),!d.trim()||t||r||x())}}),(0,a.jsxs)("div",{className:"flex w-full flex-wrap items-center justify-between gap-2 px-2 pb-2",children:[(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:(0,a.jsx)(v.T,{size:"sm",className:"h-6 min-w-0 px-2",startContent:(0,a.jsx)(b.In,{className:"text-default-500",icon:"solar:paperclip-linear",width:14}),variant:"flat",isDisabled:t||r,children:(0,a.jsx)("span",{className:"text-xs",children:"Attach"})})}),(0,a.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,a.jsxs)("p",{className:"py-1 text-tiny text-default-400",children:[d.length,"/2000"]}),(0,a.jsx)("span",{className:"text-xs text-default-400",children:"⏎ to send, ⇧+⏎ for new line"})]})]})]})]})}S.displayName="PromptInput";let _=n.memo(function(e){let{workflowID:s,onSendMessage:t,sessionId:o}=e,[c,d]=(0,n.useState)([]),u=(0,n.useRef)(null),{theme:x}=(0,r.D)(),[f,p]=(0,n.useState)(o||null),h=async()=>{if(s&&!o)try{let e=await (0,i.Zh)(s);p(e.id)}catch(e){console.error("Error creating test session:",e)}},g=async()=>{if(o)try{let e=(await (0,i.Ht)(o)).messages.map(e=>({role:e.content.role,message:e.content.content,runId:e.run_id}));d(e)}catch(e){console.error("Error fetching session messages:",e)}};(0,n.useEffect)(()=>{o?g():h()},[s,o]),(0,n.useEffect)(()=>{if(s&&!o){let e=sessionStorage.getItem("chat_messages_".concat(f||"default"));if(e)try{d(JSON.parse(e))}catch(e){console.error("Error parsing stored messages:",e)}}},[f,o]),(0,n.useEffect)(()=>{s&&!o&&c.length>0&&sessionStorage.setItem("chat_messages_".concat(f),JSON.stringify(c))},[c,s,o]);let{isLoading:w,error:v,executeWorkflow:j,cleanup:y}=m({workflowID:s,sessionId:f}),N=()=>"/pyspur-black.png",b=(0,n.useCallback)(async e=>{if(!e.trim())return;let a={role:"user",message:e};d(e=>[...e,a]);try{if(t&&await t(e),s){let s=await j(e);s&&d(e=>[...e,s])}else setTimeout(()=>{let s={role:"assistant",message:'This is a simulated response (no workflow connected): "'.concat(e,'"')};d(e=>[...e,s])},1e3)}catch(e){console.error("Error sending message:",e),d(e=>[...e,{role:"assistant",message:"Sorry, an error occurred while processing your message."}])}},[t,s,j]),I=(0,n.useCallback)(async()=>{s&&sessionStorage.removeItem("chat_messages_".concat(f||"default")),d([]),await h()},[s]);(0,n.useEffect)(()=>{u.current&&(u.current.scrollTop=u.current.scrollHeight)},[c,w]),(0,n.useEffect)(()=>()=>{y()},[y]);let C=(0,n.useCallback)(()=>0===c.length?(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[300px] h-full p-4 text-center",children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("img",{src:"/pyspur_white.png",alt:"PySpur Chat",className:"w-16 h-16 dark:block hidden"}),(0,a.jsx)("img",{src:"/pyspur-black.png",alt:"PySpur Chat",className:"w-16 h-16 dark:hidden block"})]}),(0,a.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Welcome to Spur Chat"}),(0,a.jsx)("p",{className:"text-default-500 mb-4 max-w-md",children:s?"This chat is powered by your workflow. Send a message to get started!":"No workflow is connected yet. Please connect a workflow to use this chat interface."}),!s&&(0,a.jsx)("p",{className:"text-xs text-default-400 mb-2",children:"Tip: Build a workflow that takes a message input and produces a response output."})]}):(0,a.jsxs)("div",{className:"flex flex-col gap-2 px-1",children:[c.map((e,s)=>(0,a.jsx)(k,{avatar:"assistant"===e.role?N():"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSIxMiIgY3k9IjYiIHI9IjQiIGZpbGw9ImN1cnJlbnRDb2xvciIvPjxwYXRoIGZpbGw9ImN1cnJlbnRDb2xvciIgZD0iTTIwIDE3LjVjMCAyLjQ4NSAwIDQuNS04IDQuNXMtOC0yLjAxNS04LTQuNVM3LjU4MiAxMyAxMiAxM3M4IDIuMDE1IDggNC41Ii8+PC9zdmc+",message:e.message,messageClassName:"user"===e.role?"bg-content3 text-content3-foreground":"",className:"py-0",runId:"assistant"===e.role?e.runId:void 0},s)),w&&(0,a.jsx)(k,{avatar:N(),message:"Thinking...",status:"loading",className:"py-0"}),v&&(0,a.jsx)(k,{avatar:N(),message:"Error: ".concat(v),messageClassName:"bg-danger-100 text-danger-700",className:"py-0"})]}),[c,w,v,s,x]),S=(0,n.useCallback)(()=>(0,a.jsx)(E,{onSendMessage:b,isLoading:w,placeholder:s?"Send a message...":"No workflow connected",disabled:!s,showRegenerateButton:!1}),[b,w,s]);return(0,a.jsxs)("div",{className:"flex h-full w-full max-w-full flex-col",children:[(0,a.jsxs)("div",{className:"flex w-full flex-wrap items-center justify-between gap-2 border-b-small border-divider py-1 px-4 flex-shrink-0",children:[(0,a.jsx)("p",{className:"text-sm font-medium",children:"Chat with your Spur"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[c.length>0&&(0,a.jsx)("button",{onClick:I,className:"text-xs text-default-500 hover:text-default-700","aria-label":"Clear chat history",children:"Clear chat"}),(0,a.jsx)("p",{className:"text-xs text-default-400",children:f?"Session ID: ".concat(f):"No active session"})]})]}),(0,a.jsx)(l.H,{className:"flex flex-col p-2 overflow-y-auto flex-grow",ref:u,children:(0,a.jsx)(C,{})}),(0,a.jsx)("div",{className:"p-2 border-t border-divider flex-shrink-0",children:(0,a.jsx)(S,{})})]})})}}]);